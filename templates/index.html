<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Cubagem - Jacuzzi</title>
<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #f0f4f8;
  color: #2c3e50;
}

header {
  background: #004080;
  padding: 15px 30px;
  display: flex;
  align-items: center;
  color: white;
}

header img {
  height: 50px;
  margin-right: 20px;
}

header h1 {
  font-size: 24px;
  margin: 0;
}

/* Container principal */
main {
  max-width: 1100px;
  margin: 20px auto;
  padding: 0 20px 50px 20px;
}

/* Card */
.card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.08);
  padding: 20px;
  margin-bottom: 25px;
}

/* Títulos */
h2 {
  color: #004080;
  margin-top: 0;
  margin-bottom: 15px;
}

/* Inputs e botões */
input[type="text"], input[type="number"] {
  padding: 10px;
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 15px;
  box-sizing: border-box;
}

button {
  background: #004080;
  color: white;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  transition: 0.2s;
  margin-right: 10px;
  margin-top: 5px;
}

button:hover {
  background: #0066cc;
}

/* Lista de produtos */
ul {
  list-style: none;
  padding: 0;
}

li.produto {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  margin: 5px 0;
  background: #fafafa;
}

li.produto button {
  margin-left: 5px;
  background: #27ae60;
  font-size: 13px;
  padding: 5px 10px;
}

li.produto button:hover {
  background: #2ecc71;
}

/* Resultado cubagem */
#resultado, #resultado_busca {
  background: #f9fbff;
  border: 1px solid #dce6f5;
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

table th, table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
  font-size: 13px;
}

table th {
  background: #004080;
  color: white;
}

/* Divisão de seções */
.section {
  margin-bottom: 25px;
}

/* Botões dentro de listas */
.produto-buttons button {
  margin-left: 5px;
}

/* Responsividade */
@media(max-width: 768px) {
  header { flex-direction: column; text-align: center; }
  header img { margin-bottom: 10px; }
  button { width: 100%; margin-top: 10px; }
}
</style>
</head>
<body>
<header>
  <img src="https://i.postimg.cc/VLwvF6FG/jacuzzi-logo.png" alt="Jacuzzi Logo">
  <h1>Sistema de Cubagem</h1>
</header>

<main>
  <!-- Seção 1: Busca de produtos -->
  <div class="card section">
    <h2>Buscar Produtos</h2>
    <input type="text" id="busca" placeholder="Buscar por código ou nome...">
    <ul id="resultados"></ul>

    <h3>Itens Selecionados</h3>
    <ul id="selecionados"></ul>
    <button onclick="calcularCubagem()">Calcular Cubagem</button>
    <button onclick="exportarPDF()">Exportar PDF</button>
  </div>

  <!-- Seção 2: Resultado cubagem -->
  <div class="card section">
    <h2>Resultado da Cubagem</h2>
    <div id="resultado"></div>
  </div>

  <!-- Seção 3: Buscar cubagem pelo número -->
  <div class="card section">
    <h2>Buscar Cubagem pelo Número</h2>
    <input type="number" id="busca_cubagem" placeholder="Digite o número da cubagem...">
    <button onclick="buscarCubagem()">Buscar Cubagem</button>
    <div id="resultado_busca"></div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// --- JS permanece igual ao anterior ---
const resultadosEl = document.getElementById("resultados");
const selecionadosEl = document.getElementById("selecionados");
const selecionados = [];
let ultimoResultado = null;

document.getElementById("busca").addEventListener("input", async (e) => {
  const q = e.target.value;
  if (!q) { resultadosEl.innerHTML = ""; return; }
  const res = await fetch(`/buscar?q=${q}`);
  const data = await res.json();
  resultadosEl.innerHTML = "";
  data.forEach(prod => {
    const li = document.createElement("li");
    li.className = "produto";
    li.innerHTML = `<span>${prod.Codigo} - ${prod.Nome} (${prod.m3_total.toFixed(3)} m³, ${prod.Peso.toFixed(2)} kg)</span>
      <button onclick="adicionar('${prod.Codigo}','${prod.Nome}')">Adicionar</button>`;
    resultadosEl.appendChild(li);
  });
});

function adicionar(codigo, nome) {
  const existente = selecionados.find(i => i.codigo === codigo);
  if (existente) existente.quantidade++;
  else selecionados.push({ codigo, nome, quantidade:1 });
  atualizarSelecionados();
}

function incrementar(codigo) { const item = selecionados.find(i => i.codigo===codigo); if(item){item.quantidade++; atualizarSelecionados();} }
function decrementar(codigo) { const item = selecionados.find(i => i.codigo===codigo); if(item){ if(item.quantidade>1){item.quantidade--;} else{remover(codigo);} atualizarSelecionados();} }
function remover(codigo){ const idx = selecionados.findIndex(i=>i.codigo===codigo); if(idx>-1) selecionados.splice(idx,1); atualizarSelecionados();}
function atualizarSelecionados(){
  selecionadosEl.innerHTML="";
  selecionados.forEach(item=>{
    const li=document.createElement("li");
    li.className="produto";
    li.innerHTML=`<span>${item.codigo} - ${item.nome} | Qtd: ${item.quantidade}</span>
      <div class="produto-buttons">
      <button onclick="incrementar('${item.codigo}')">➕</button>
      <button onclick="decrementar('${item.codigo}')">➖</button>
      <button onclick="remover('${item.codigo}')">❌</button>
      </div>`;
    selecionadosEl.appendChild(li);
  });
}

async function calcularCubagem(){
  const res=await fetch("/cubagem",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({itens:selecionados})});
  const data=await res.json();
  ultimoResultado=data;

  let tabela=`<table><thead><tr><th>Código</th><th>Nome</th><th>Qtd</th><th>C (cm)</th><th>L (cm)</th><th>A (cm)</th><th>Volume (m³)</th><th>Peso (kg)</th></tr></thead><tbody>`;
  data.itens.forEach(item=>{ tabela+=`<tr><td>${item.Codigo}</td><td>${item.Nome}</td><td>${item.Quantidade}</td>
  <td>${item.Comprimento}</td><td>${item.Largura}</td><td>${item.Altura}</td><td>${item.m3_total.toFixed(3)}</td><td>${item.Peso.toFixed(2)}</td></tr>`; });
  tabela+="</tbody></table>";

  document.getElementById("resultado").innerHTML=`
  <p><strong>Número da Cubagem:</strong> ${data.numero_cubagem}</p>
  <p><strong>Total Volume:</strong> ${data.volume_total.toFixed(3)} m³</p>
  <p><strong>Total Peso:</strong> ${data.peso_total.toFixed(2)} kg</p>
  <p><strong>Caixas possíveis:</strong></p>
  <ul>${data.caixas.map(c=>`<li>${c.nome} - ${c.capacidade} m³</li>`).join("")}</ul>
  <h3>Itens Selecionados</h3>
  ${tabela}`;
}

async function buscarCubagem(){
  const num = document.getElementById("busca_cubagem").value;
  if(!num){ alert("Digite um número de cubagem"); return; }
  const res = await fetch(`/cubagem/${num}`);
  if(res.status!==200){ alert("Cubagem não encontrada"); return; }
  const data = await res.json();

  let tabela=`<table><thead><tr><th>Código</th><th>Nome</th><th>Qtd</th><th>C (cm)</th><th>L (cm)</th><th>A (cm)</th><th>Volume (m³)</th><th>Peso (kg)</th></tr></thead><tbody>`;
  data.itens.forEach(item=>{ tabela+=`<tr><td>${item.Codigo}</td><td>${item.Nome}</td><td>${item.Quantidade}</td>
  <td>${item.Comprimento}</td><td>${item.Largura}</td><td>${item.Altura}</td><td>${item.m3_total.toFixed(3)}</td><td>${item.Peso.toFixed(2)}</td></tr>`; });
  tabela+="</tbody></table>";

  document.getElementById("resultado_busca").innerHTML=`
  <p><strong>Número da Cubagem:</strong> ${data.id}</p>
  <p><strong>Total Volume:</strong> ${data.volume_total.toFixed(3)} m³</p>
  <p><strong>Total Peso:</strong> ${data.peso_total.toFixed(2)} kg</p>
  <h3>Itens</h3>
  ${tabela}`;
}

async function exportarPDF(){
  if(!ultimoResultado){ alert("Calcule a cubagem antes de exportar."); return; }
  const {jsPDF} = window.jspdf;
  const doc=new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
  const margem=10, largura=190; let y=10;
  const img=new Image(); img.src="https://i.postimg.cc/VLwvF6FG/jacuzzi-logo.png";
  img.onload=function(){
    doc.addImage(img,"PNG",margem,y,50,20); y+=25;
    doc.setFontSize(18); doc.text("Relatório de Cubagem",70, y); y+=10;
    doc.setFontSize(12);
    doc.text(`Número da Cubagem: ${ultimoResultado.numero_cubagem}`,margem,y); y+=7;
    doc.text(`Total Volume: ${ultimoResultado.volume_total.toFixed(3)} m³`,margem,y); y+=7;
    doc.text(`Total Peso: ${ultimoResultado.peso_total.toFixed(2)} kg`,margem,y); y+=10;
    doc.text("Caixas possíveis:",margem,y); y+=7;
    ultimoResultado.caixas.forEach(c=>{ doc.text(`- ${c.nome} (${c.capacidade} m³)`, margem+5, y); y+=7; });
    y+=5; doc.setFontSize(14); doc.text("Itens Selecionados:",margem,y); y+=7;
    doc.setFontSize(11);
    ultimoResultado.itens.forEach(item=>{
      const linha=`${item.Codigo} - ${item.Nome} | Qtd:${item.Quantidade} | C:${item.Comprimento} x L:${item.Largura} x A:${item.Altura} cm | V:${item.m3_total.toFixed(3)} m³ | P:${item.Peso.toFixed(2)} kg`;
      const linhasQuebradas=doc.splitTextToSize(linha, largura);
      linhasQuebradas.forEach(txt=>{
        if(y>280){ doc.addPage(); y=20; }
        doc.text(txt,margem,y); y+=6;
      });
    });
    doc.save("relatorio_cubagem.pdf");
  };
}
</script>
</body>
</html>
